=LET(hours,IF($I3<=cutoff_date,LET(start,IF(AND($G3>=J$2,$G3<=EOMONTH(J$2,0)),$G3,0),end,IF(AND($H3>=J$2,$H3<=EOMONTH(J$2,0)),$H3,0),IF(AND(start>0,end=0),NETWORKDAYS($G3,EOMONTH(J$2,0)),IF(AND(start=0,end>0),NETWORKDAYS(J$2,$H3),IF(AND(J$2>$G3,J$2<$H3),NETWORKDAYS(J$2,EOMONTH(J$2,0)),IF(AND($G3>=J$2,$H3<=EOMONTH(J$2,0)),NETWORKDAYS($G3,$H3),0))))),0),LET(fte_col,IF($E3="Internal fulfilment",internal_pct_hours_charged_col,IF($E3="Project/account",project_account_hours_charged_col,hires_and_contractors_hours_charged_col)),hours*VLOOKUP($D3,lock_settings_per_cl,fte_col,FALSE)))
